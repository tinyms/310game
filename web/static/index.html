<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Odds Query Builder</title>
    <link rel="stylesheet" href="http://fonts.googleapis.com/css?family=PT+Sans:400,700,400italic,700italic">
    <link rel="stylesheet" href="yui3/cssgrids/cssgrids-min.css">
    <link rel="stylesheet" href="yui3/cssbutton/cssbutton-min.css">
    <link rel="stylesheet" href="css/main.css">
    <link rel="stylesheet" href="vendor/prettify/prettify-min.css">
    <script src="yui3/yui/yui-min.js"></script>
    <style type="text/css">
        html {
            -webkit-text-size-adjust: 100%;
            -ms-text-size-adjust: 100%;
        }

        body, table, input, textarea, select, button {
            font-family: "微软雅黑", Verdana, sans-serif, "宋体";
        }

        .yui3-skin-sam .yui3-datatable tr.myhilite td {
            background-color: #C0ffc0;
        }

        #datatable_matchs tbody tr {
            /*  Turn on cursor to show TR's are selectable on Master DataTable only  */
            cursor: pointer;
        }

            /* Hide overlay markup while loading, if js is enabled */
        .yui3-js-enabled .yui3-overlay-loading {
            top: -1000em;
            left: -1000em;
            position: absolute;
        }

            /* Overlay Look/Feel */
        .yui3-overlay-content {
            background-color: #ECEFFB;
            border: 1px solid #9EA8C6;
            border-radius: 3px;
            box-shadow: 3px 3px 5px rgba(0, 0, 0, 0.25);
        }

        .yui3-overlay-content .yui3-widget-hd {
            background-color: #B6BFDA;
            color: #30418C;
            font-size: 120%;
            font-weight: bold;
            padding: 0.2em 0.5em 0.3em;
            border-radius: 2px 2px 0 0;
        }

        .yui3-overlay-content .yui3-widget-bd {
            padding: 0.4em 0.6em 0.5em;
        }

        .yui3-overlay-content .yui3-widget-ft {
            background-color: #DFE3F5;
            padding: 0.4em 0.6em 0.5em;
            border-radius: 0 0 2px 2px;
        }
    </style>
</head>
<body class="yui3-skin-sam">
<div id="doc" style="margin-top: 15px;">
    <div class="yui3-g">
        <div class="yui3-u-3-4">
            <div id="main">
                <div class="content">
                    <style scoped>
                            /* css to counter global site css */
                        .example table {
                            width: auto;
                        }

                        .example caption {
                            display: table-caption;
                        }

                        .example th,
                        .example td {
                            border: 0 none;
                            text-transform: none;
                        }
                    </style>
                    <div class="example yui3-skin-sam">
                        <div>
                            实力: <select id="Detect_Result">
                            <option value="3">3</option>
                            <option value="1">1</option>
                            <option value="0">0</option>
                            <option value="31">31</option>
                            <option value="10">10</option>
                        </select>
                            (胜: <select id="diff_win">
                            <option value="N">不变</option>
                            <option value="H">高</option>
                            <option value="L">低</option>
                        </select>
                            平: <select id="diff_draw">
                            <option value="N">不变</option>
                            <option value="H">高</option>
                            <option value="L">低</option>
                        </select>
                            负: <select id="diff_lost">
                            <option value="N">不变</option>
                            <option value="H">高</option>
                            <option value="L">低</option>
                        </select>)-(
                            方向: <select id="odds_direction">
                            <option value="-1"></option>
                            <option value="3">主胜</option>
                            <option value="0">客胜</option>
                            <option value="1">均等</option>
                        </select>
                            模式: <input type="text" id="odds_int_num"/>
                            )
                            <input id="btn_QueryHistoryMatchs" class='yui3-button' type="button" value="搜索"
                                   style="margin-left: 10px;"/>
                        </div>

                        <div id="datatable_matchs" style="margin-top: 10px;"></div>

                        <div id="overlay" class="yui3-overlay-loading">
                            <div class="yui3-widget-hd">球队概况及变赔</div>
                            <div class="yui3-widget-bd">Overlay Body</div>
                            <div class="yui3-widget-ft"></div>
                        </div>

                        <textarea id="overlay-content-template" style="display: none;">
                            <div style="border-bottom: 1px solid #ee8811;margin-top: 5px;">概况</div>
                            <div style="margin-top: 5px; text-indent: 10px;">
                                <div>近10场: <%= this.last_10%></div>
                                <div>近06场: <%= this.last_6%></div>
                                <div>近04场: <%= this.last_4%></div>
                                <div>战绩状态: <%= this.last_battle%></div>
                            </div>
                            <div style="border-bottom: 1px solid #ee8811;margin-top: 5px;">变盘</div>
                            <div style="margin-top: 5px;text-indent: 10px;">
                                <div>威廉: <%== this.odds_wl_c%></div>
                                <div>立博: <%== this.odds_lb_c%></div>
                                <div>澳门: <%== this.odds_am_c%></div>
                                <div>贝塔: <%== this.odds_beta_c%></div>
                                <div>易博: <%== this.odds_ysb_c%></div>
                            </div>
                        </textarea>
                    </div>

                </div>
            </div>
        </div>
    </div>
</div>
<script type="text/javascript">
    YUI().use("node", "datatable", "datasource-get", "datatype-number", "overlay", "template",
            "datasource-jsonschema", "datatable-datasource", function (Y) {
                function format_float(num) {
                    return Y.Number.format(num, {decimalPlaces: 2})
                }

                function format_odds_change(odds, odds_c) {
                    var a = format_float(odds[0])+" "+format_float(odds[1])+" "+format_float(odds[2])
                    var b = format_float(odds_c[0])+" "+format_float(odds_c[1])+" "+format_float(odds_c[2])
                    var tmp = [odds_c[0] - odds[0], odds_c[1] - odds[1], odds_c[2] - odds[2]];
                    var tmp2 = [];
                    if (tmp[0] > 0) {
                        tmp2.push("<span style='color:red;'>+" + format_float(tmp[0]) + "</span>");
                    } else if (tmp[0] < 0) {
                        tmp2.push("<span style='color:green;'>" + format_float(tmp[0]) + "</span>");
                    } else {
                        tmp2.push("+" + format_float(tmp[0]));
                    }
                    if (tmp[1] > 0) {
                        tmp2.push("<span style='color:red;'>+" + format_float(tmp[1]) + "</span>");
                    } else if (tmp[1] < 0) {
                        tmp2.push("<span style='color:green;'>" + format_float(tmp[1]) + "</span>");
                    } else {
                        tmp2.push("+" + format_float(tmp[1]));
                    }
                    if (tmp[2] > 0) {
                        tmp2.push("<span style='color:red;'>+" + format_float(tmp[2]) + "</span>");
                    } else if (tmp[2] < 0) {
                        tmp2.push("<span style='color:green;'>" + format_float(tmp[2]) + "</span>");
                    } else {
                        tmp2.push("+" + format_float(tmp[2]));
                    }
                    var c = tmp2.join(" ")
                    return a + "~" + b + "~" + c;
                }

                //Details Tip.
                var overlay = new Y.Overlay({
                    srcNode: "#overlay",
                    width: "400px",
                    height: "300px",
                    visible: false,
                    shim: false,
                    allowHTML: true
                });
                var url = "/match/history", dataSource, grid;
                dataSource = new Y.DataSource.Get({ source: url });
                dataSource.plug(Y.Plugin.DataSourceJSONSchema, {
                    schema: {
                        resultListLocator: "matchs",
                        resultFields: [
                            { key: 'id'},
                            { key: 'score'},
                            { key: 'actual_result'},
                            { key: 'detect_result'},
                            { key: 'balls_diff'},
                            { key: 'vs_team_names'},
                            { key: 'last_10'},
                            { key: 'last_6'},
                            { key: 'last_4'},
                            { key: 'last_battle'},
                            { key: 'odds_wl'},
                            { key: 'odds_lb'},
                            { key: 'odds_am'},
                            { key: 'odds_beta'},
                            { key: 'odds_ysb'},
                            { key: 'odds_wl_c'},
                            { key: 'odds_lb_c'},
                            { key: 'odds_am_c'},
                            { key: 'odds_beta_c'},
                            { key: 'odds_ysb_c'},
                            { key: 'wl_lb_flag'},
                            { key: 'wl_lb_diff'},
                            { key: 'evt_name'},
                            { key: 'url_key'},
                            { key: 'vs_date'},
                            //Extra Fields
                            { key: 'first_odds_wl'}
                        ]
                    }
                });

                grid = new Y.DataTable({
                    scrollable: "y",
                    columns: [
                        {   key: 'select',
                            label: "选择",
                            allowHTML: true, // to avoid HTML escaping
                            formatter: '<input type="checkbox"/>'
                        },
                        {label: "球差", key: "balls_diff"},
                        {label: "预测", key: "detect_result"},
                        {label: "赛果", key: "actual_result"},
                        {label: "初盘(威廉)", key: "odds_wl", formatter: function (col) {
                            var odds = col.value;
                            var draw = parseInt(odds[1])
                            var dot_part = odds[1] - draw
                            if (dot_part >= 0.5) {
                                return format_float(odds[0]) + " <span style='color: red;'>" + format_float(odds[1]) + "</span> " + format_float(odds[2]);
                            }
                            return format_float(odds[0]) + " " + format_float(odds[1]) + " " + format_float(odds[2]);
                        }, allowHTML: true},
                        {label: "初盘(立博)", key: "odds_lb", formatter: function (col) {
                            var odds = col.value;
                            var draw = parseInt(odds[1])
                            var dot_part = odds[1] - draw
                            if (dot_part >= 0.5) {
                                return format_float(odds[0]) + " <span style='color: red;'>" + format_float(odds[1]) + "</span> " + format_float(odds[2]);
                            }
                            return format_float(odds[0]) + " " + format_float(odds[1]) + " " + format_float(odds[2]);
                        }, allowHTML: true},
                        {label: "差异幅度", key: "wl_lb_diff", formatter: function (col) {
                            var odds = col.value;
                            return format_float(odds[0]) + " " + format_float(odds[1]) + " " + format_float(odds[2]);
                        }, allowHTML: true},
                        {label: "对阵球队", key: "vs_team_names"},
                        {label: "比分", key: "score"},
                        {label: "赛事", key: "evt_name"},
                        {label: "比赛日期", key: "vs_date"}
                    ]
                });

                grid.addAttr("selectedRow", { value: null });
                grid.delegate('click', function (e) {

                    overlay.show();
                    overlay.move(e.pageX + 30, e.pageY - 15);
                    this.set('selectedRow', e.currentTarget);
                }, '.yui3-datatable-data tr', grid);

                grid.after('selectedRowChange', function (e) {
                    var last_tr = e.prevVal, tr = e.newVal, rec = this.getRecord(tr);
                    if (last_tr) {
                        last_tr.removeClass("myhilite");
                    }
                    tr.addClass("myhilite");
                    var data = {
                        last_10: rec.get("last_10"),
                        last_6: rec.get("last_6"),
                        last_4: rec.get("last_4"),
                        last_battle: rec.get("last_battle"),
                        odds_wl_c: format_odds_change(rec.get("odds_wl"), rec.get("odds_wl_c")),
                        odds_lb_c: format_odds_change(rec.get("odds_lb"), rec.get("odds_lb_c")),
                        odds_am_c:format_odds_change(rec.get("odds_am"), rec.get("odds_am_c")),
                        odds_beta_c:format_odds_change(rec.get("odds_beta"), rec.get("odds_beta_c")),
                        odds_ysb_c:format_odds_change(rec.get("odds_ysb"), rec.get("odds_ysb_c"))
                    };
                    console.log(rec.get("vs_team_names"));
                    var tpl = Y.one("#overlay-content-template").get("value");
                    var micro = new Y.Template();
                    var html = micro.render(tpl, data);
                    overlay.set("bodyContent", html);
                });
                grid.plug(Y.Plugin.DataTableDataSource, { datasource: dataSource });
                grid.render("#datatable_matchs");

                overlay.render();
                Y.one("#btn_QueryHistoryMatchs").on("click", function (e) {
                    var Detect_Result = Y.one("#Detect_Result");
                    var win = Y.one("#diff_win");
                    var draw = Y.one("#diff_draw");
                    var lost = Y.one("#diff_lost");
                    var odds_direction = Y.one("#odds_direction").get("value");
                    var odds_int_num = Y.one("#odds_int_num").get("value");
                    var flag = win.get("value") + draw.get("value") + lost.get("value");
                    var r = Detect_Result.get("value");
                    var query = "?d_result=" + r + "&flag=" + flag + "&odds_direction=" + odds_direction + "&odds_int_num=" + odds_int_num;
                    grid.datasource.load({ request: query });
                });
            });
</script>
<script src="vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
</body>
</html>
